!function(){function i(){l=document.getElementById("invadersCanvas"),c=window.innerWidth,o=window.innerHeight,c=800,o=c/1.5,l.width=c,l.height=o;var i=document.getElementById("game");i.style.width=c+"px",i.style.height=o+"px",input=new r,p=g.Splash,f=l.getContext("2d"),d=new Image,d.src="res/sprite_sheet.png",d.src="res/sprite_sheet-transparent.png",x.volume=.01,m.volume=.01,_.volume=.01,d.onload=function(){initSprites(this),a=n(50),u=0,b.init(),S.init(),M.init(),E.init(),e()}}function t(){M.reset(),E.reset(),M.init(),E.init(),b.init(),v=[]}function e(){var i=function(){s(),h(),window.requestAnimationFrame(i)};i()}function s(){u++,p===g.Game&&M.update(),S.update(),E.update(),b.update()}function h(){f.fillStyle="#333",f.fillRect(0,0,c,o),f.fillStyle="#000",f.fillRect(5,5,c-10,o-10),M.draw(f),S.draw(f),E.draw(f),b.draw(),p!==g.Game&&(f.fillStyle="rgba(0, 0, 0, .8)",f.fillRect(0,0,c,o),s_title.draw(f,c/2-s_title.width/2,100),p===g.Splash&&(f.save(),f.font="25px monospace",f.fillStyle="rgba(255,100,110,.7)",f.fillText("PAUSED",330,290),f.font="20px monospace",f.fillStyle="white",f.fillText("Press ENTER to continue",250,320),f.restore()),p===g.End&&(f.save(),f.font="30px monospace",f.fillStyle="rgba(200,0,0,1)",f.fillText("GAME OVER",310,290),f.font="20px monospace",f.fillStyle="white",f.fillText("Press ENTER to try again",245,320),f.restore()))}function n(i){var t=i||20,e=function(){f.fillStyle="rgba(255,255,255,.5)",f.fillRect(Math.random()*o,Math.random()*c,3*Math.random(),3*Math.random()),f.fill()};f.clearRect(0,0,c,o),f.fillStyle="rgba(0,0,0,1)",f.fillRect(0,0,c,o);for(var s=0;t>s;s++)e();var h=l.toDataURL("image/png").replace("image/png","image/octet-stream");a=h;var n=new Image;return n.src=h,n}function r(){this.down={},this.pressed={};var i=this;document.addEventListener("keydown",function(e){13===e.which&&(p===g.Splash?(p=g.Game,v=[]):p===g.Game?(console.log("velo: "+M.velocity),p=g.Splash):p===g.End&&(t(),p=g.Game)),i.down[e.which]=!0}),document.addEventListener("keyup",function(t){i.down[t.which]=!1,i.pressed[t.which]=!1})}var l,a,o,c,f,d,u,p,v=[],y=[],w=null,x=new Audio("sfx/explosion.wav"),m=new Audio("sfx/shoot.wav"),_=new Audio("sfx/ufo_highpitch.wav"),g={Splash:0,Game:1,End:2},M={_aliens:[],rows:[0,1,1,2,2],cols:10,x:20,y:60,step:30,frame:0,dir:1,animation:[0,1],velocity:60,reset:function(){this._aliens=[],this.velocity=0,this.x=20,this.y=60,this.dir=1,this.frame=0,u=0},init:function(){this.velocity=75,this.y+=Math.min(10*b.level,100),v=[],this._aliens=[];for(var i=0;i<this.rows.length;i++)for(var t=this.rows[i],e=0==t?7:1==t?4:3,s=0;s<this.cols;s++){var h=this.x+this.step*s+e,n=this.y+this.step*i;this._aliens.push({sprite:s_alien[t],x:h,y:n,w:s_alien[t][0].width,h:s_alien[t][0].height,value:50-20*t})}},update:function(){0===this._aliens.length&&(b.lives+=b.lives<4?1:0,b.level++,M.reset(),M.init());for(var i=0,t=this._aliens.length;t>i;i++)for(var e=0,s=v.length;s>e;e++){var h=this._aliens[i],n=v[e];try{-1==n.dir&&n.x+n.w>=h.x&&n.x<=h.x+h.w&&n.y+n.h>=h.y&&n.y<=h.y+h.h&&(y.push({value:h.value,x:h.x,y:h.y,t:0}),b.score+=h.value,this._aliens.splice(i,1),i--,t--,v.splice(e,1),e--,s--,u-=u%60-1)}catch(r){}}if(null!==w){_.play();for(var l=w,i=0,t=v.length;t>i;i++){var n=v[i];try{-1===n.dir&&n.x+n.w>=l.x&&n.x<=l.x+l.w&&n.y+n.h>=l.y&&n.y<=l.y+l.h&&(b.score+=l.value,y.push({value:l.value,x:l.x,y:l.y,t:0}),v.splice(i,1),w=null)}catch(r){}}}if(u%this.velocity==0){this.frame++;for(var a=c,o=0,f=0,d=this.step-Math.floor(5*Math.random()),i=0,t=this._aliens.length;t>i;i++){var h=this._aliens[i];h.x+=d*this.dir,a=Math.min(h.x,a),o=Math.max(h.x,o)}if(30>a||o>c-30-this.step){this.dir*=-1;for(var i=0,t=this._aliens.length;t>i;i++){var h=this._aliens[i];if(h.x+=this.step*this.dir,h.y+=this.step,f=Math.max(f,h.y),f>=440)return void(p=g.End)}}}if(this._aliens.length>1&&u%10===0&&Math.random()<.05*b.level){var h=this._aliens[Math.floor(Math.random()*this._aliens.length)];v.push({f:0,sprite:s_bulletAlien,x:h.x,y:h.y-2,v:2,dir:1}),m.play()}if(null==w&&this._aliens.length>1&&u%10===0&&Math.random()<.005){var x=Math.random()<.5?-1:1;w={sprite:s_ufo,x:1==x?0:c,y:35,w:s_ufo.width,h:s_ufo.height,dir:x,velocity:Math.floor(3*Math.random())+2,value:10*Math.floor(20*Math.random())+100}}this.velocity=this._aliens.length+18-3*Math.min(b.level,5)},draw:function(i){for(var t=0,e=this._aliens.length;e>t;t++){var s=this._aliens[t];s.sprite[this.frame%this.animation.length].draw(i,s.x,s.y)}null!==w&&(s_ufo.draw(i,w.x,w.y),w.x+=w.velocity*w.dir,(w.x<0-s_ufo.width||w.x>c)&&(w=null))}},S={x:0,y:0,w:0,h:0,init:function(){this.x=c/2,this.y=o-75,this.w=s_ship.width,this.h=s_ship.height},update:function(){for(var i=0,t=v.length;t>i;i++){var e=v[i];u%30==0&&e.f++,e.y+=e.v*e.dir,(e.y<0||e.y>o)&&(v.splice(i,1),i--,t--);try{if(1==e.dir&&e.x>this.x&&e.x<this.x+this.w&&e.y>=this.y&&e.y<=this.y+this.h){if(x.play(),0==b.lives)return void(p=g.End);b.lives-=b.lives>0?1:0,v.splice(i--,1),t--}}catch(s){}}if(input.isPressed(32)&&(v.push({f:0,sprite:s_bulletShip,x:this.x+this.w/2,y:this.y+2,w:s_bulletShip[0].width,h:s_bulletShip[0].height,v:3,dir:-1}),b.score-=b.score>0?1:0),input.isDown(37)){if(this.x<30)return;input.shiftModified()?this.x-=4:this.x-=2}if(input.isDown(39)){var h=c-30-s_ship.width;if(this.x>h)return;input.shiftModified()?this.x+=4:this.x+=2}},draw:function(){s_ship.draw(f,this.x,o-75);for(var i=0,t=v.length;t>i;i++){var e=v[i];e.sprite[e.f%2].draw(f,e.x,e.y)}}},E={_cities:[],step:138,num:5,x:0,y:0,w:0,h:0,reset:function(){this._cities=[]},init:function(){_cities=[],this.w=s_city[0].width,this.h=s_city[0].height;for(var i=0;i<this.num;i++)this._cities.push({sprite:s_city,x:100+this.step*i,y:o-150,hits:0,w:this.w,h:this.h})},update:function(){for(var i=0,t=this._cities.length;t>i;i++)for(var e=0,s=v.length;s>e;e++){var h=this._cities[i],n=v[e];try{n.x>h.x&&n.x<h.x+h.w&&n.y>=h.y&&n.y<=h.y+h.h&&(v.splice(e,1),e--,s--,h.hits++,h.hits>5&&(this._cities.splice(i,1),i--,t--))}catch(r){}}},draw:function(i){for(var t=0,e=this._cities.length;e>t;t++){var s=this._cities[t];s.sprite[s.hits].draw(i,s.x,s.y)}}},b={score:0,hiscore:0,lives:0,level:0,init:function(){this.hiscore=localStorage.getItem("highscore")||0,this.score=0,this.lives=3,this.level=0,console.log(this.hiscore)},update:function(){this.score>this.hiscore&&localStorage.setItem("highscore",this.score),this.hiscore=Math.max(this.hiscore,this.score)},draw:function(){s_score.draw(f,20,10);for(var i=this.score+"",t=0;t<i.length;t++){var e=i.charAt(t);s_number[e].draw(f,120+15*t,10)}f.save(),f.font="15px monospace",f.fillStyle="white",f.fillText("Level: "+(b.level+1),250,25),f.restore(),s_credit.draw(f,c/1.6,10);for(var t=0;t<this.lives;t++)s_ship.draw(f,c/1.6+s_credit.width+s_ship.width+1.3*s_ship.width*t,10);f.save(),f.font="15px monospace",f.fillStyle="rgba(255,100,100,.8)";for(var t=0;t<y.length;t++){var s=y[t];u%3==0&&s.value<100&&s.y--,u%5==0&&s.value>=100&&s.y++,s.t++,s.value>=100?(f.save(),f.font="25px monospace",f.fillText(s.value,s.x,s.y),f.restore()):f.fillText(s.value,s.x,s.y),f.fill(),s.t>60&&y.splice(t--,1)}f.restore()}};r.prototype.isDown=function(i){return this.down[i]},r.prototype.isPressed=function(i){return this.pressed[i]?!1:this.down[i]?this.pressed[i]=!0:!1},r.prototype.shiftModified=function(){return this.isDown(16)},i()}();